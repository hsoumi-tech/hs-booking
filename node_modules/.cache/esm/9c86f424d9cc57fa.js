let mongoose,moment,Reservation,Room,Hotel,Service,PricePolicy;_d9c‍.x([["getReservationById",()=>getReservationById],["getAllReservations",()=>getAllReservations],["addReservation",()=>addReservation],["deleteReservation",()=>deleteReservation],["getServiceById",()=>getServiceById],["getAllServices",()=>getAllServices],["addService",()=>addService],["updateService",()=>updateService],["deleteService",()=>deleteService],["getPricePolicyById",()=>getPricePolicyById],["getAllPricePolicies",()=>getAllPricePolicies],["addPricePolicy",()=>addPricePolicy],["updatePricePolicy",()=>updatePricePolicy],["deletePricePolicy",()=>deletePricePolicy]]);_d9c‍.w("mongoose",[["default",["mongoose"],function(v){mongoose=v}]]);_d9c‍.w("moment",[["default",["moment"],function(v){moment=v}]]);_d9c‍.w("../models/reservation",[["default",["Reservation"],function(v){Reservation=v}]]);_d9c‍.w("../models/room",[["default",["Room"],function(v){Room=v}]]);_d9c‍.w("../models/hotel",[["default",["Hotel"],function(v){Hotel=v}]]);_d9c‍.w("../models/service",[["default",["Service"],function(v){Service=v}]]);_d9c‍.w("../models/pricePolicy",[["default",["PricePolicy"],function(v){PricePolicy=v}]]);







// ###############################################################################
// ### reservation
// ###############################################################################

       const getReservationById = async id => {
  if (mongoose.Types.ObjectId.isValid(id) === false) {
    return {
      code: 422,
      message: "invalid reservation id"
    };
  }
  return Reservation.findOne({
    _id: id
  });
};

       const getAllReservations = () => {
  return Reservation.find({});
};

       const addReservation = async ({
  room,
  services = null,
  startDate,
  endDate,
  adults = 1,
  kids = 0,
  babies = 0
}) => {
  let roomPopulated = "";
  if (mongoose.Types.ObjectId.isValid(room) === false) {
    return {
      code: 422,
      message: "invalid room id"
    };
  } else {
    roomPopulated = await Room.findOne({
      _id: room
    });

    if (!roomPopulated) {
      return {
        code: 404,
        message: "room not found"
      };
    }
  }

  startDate = moment(startDate, "DD/MM/YYYY");
  endDate = moment(endDate, "DD/MM/YYYY");
  if (services) {
    for (let i = 0; i < services.length; i++) {
      if (mongoose.Types.ObjectId.isValid(services[i]) === false) {
        return {
          code: 422,
          message: `invalid service id`
        };
      } else {
        const service = await Service.findOne({
          _id: services[i]
        });
        if (!service) {
          return {
            code: 404,
            message: "service not found"
          };
        } else if (!service.hotel.equals(roomPopulated.hotel)) {
          return {
            code: 404,
            message: "service not found in this hotel"
          };
        }
      }

      // if (services[i].daysBeforeReservation < )
      _d9c‍.g.console.log(startDate.diff(moment(), 'days'))
    }
  }




  let finalPrice = 0

  const pricePolicies = await PricePolicy.find({
    hotel: roomPopulated.hotel
  })

  if (pricePolicies.length > 0) {
    let pricePolicyDaysOfTheWeek = {}
    let pricePolicyDates = []

    pricePolicies.forEach(pricePolicy => {
      if (!pricePolicy.maximumPerson || pricePolicies.maximumPerson >= adults + kids + babies) {
        if (pricePolicy.dayOfTheWeek) {
          pricePolicyDaysOfTheWeek[pricePolicy.dayOfTheWeek] = pricePolicy.value
        }
        if (pricePolicy.days && pricePolicy.days.length > 0) {
          pricePolicyDates.push({
            value: pricePolicy.value,
            days: pricePolicy.days.map(x => moment(x).format("DD/MM/YYYY"))
          })
        }
      }
    });

    let basePrice = roomPopulated.pricePerNight

    for (
      let date = startDate; startDate.isSameOrBefore(endDate); date.add(1, "days")
    ) {
      let dayPrice = 0
      if (pricePolicyDaysOfTheWeek[date.day()]) {
        dayPrice = ((pricePolicyDaysOfTheWeek[date.day()] / 100) * basePrice)
      }
      if (pricePolicyDates.length > 0) {
        const dateString = date.format("DD/MM/YYYY")
        const datePrice = pricePolicyDates.find(x => x.days.includes(dateString));
        if (datePrice) {
          dayPrice = ((datePrice.value / 100) * basePrice)
        }
      }
      finalPrice += dayPrice + basePrice
    }
  }

  finalPrice += service.price
  return new Reservation({
    room,
    services,
    price: finalPrice,
    startDate,
    endDate,
    adults,
    kids,
    babies
  }).save();
};

// export const updateReservation = async ({
//   room,
//   services,
//   price,
//   startDate,
//   endDate,
//   adults,
//   kids,
//   babies,
//   id
// }) => {
//   if (mongoose.Types.ObjectId.isValid(id) === false) {
//     return {
//       code: 422,
//       message: "invalid reservation id"
//     };
//   }

//   let reservation = await Reservation.findOne({
//     _id: id
//   });

//   if (reservation) {
//     let roomPopulated = await Room.findOne({
//       _id: reservation.room
//     });
//     if (room) {
//       if (mongoose.Types.ObjectId.isValid(room) === false) {
//         return {
//           code: 422,
//           message: "invalid room id"
//         };
//       } else if (
//         !(await Room.findOne({
//           _id: room
//         }))
//       ) {
//         return {
//           code: 404,
//           message: "room not found"
//         };
//       } else {
//         roomPopulated = await Room.findOne({
//           _id: room
//         });
//       }
//     }
//     if (services) {
//       for (let i = 0; i < services.length; i++) {
//         if (mongoose.Types.ObjectId.isValid(services[i]) === false) {
//           return {
//             code: 422,
//             message: `invalid service id`
//           };
//         } else {
//           const service = await Service.findOne({
//             _id: services[i]
//           });
//           if (!service) {
//             return {
//               code: 404,
//               message: "service not found"
//             };
//           } else if (service.hotel != roomPopulated.hotel) {
//             return {
//               code: 404,
//               message: "service not found in this hotel"
//             };
//           }
//         }
//       }
//     }

//     reservation.reservation = reservation ?
//       reservation :
//       reservation.reservation;
//     reservation.services = services ? services : reservation.services;
//     reservation.price = price ? price : reservation.price;
//     reservation.startDate = startDate ? startDate : reservation.startDate;
//     reservation.endDate = endDate ? endDate : reservation.endDate;
//     reservation.adults = adults ? adults : reservation.adults;
//     reservation.kids = kids ? kids : reservation.kids;
//     reservation.babies = babies ? babies : reservation.babies;

//     return reservation.save();
//   } else {
//     return {
//       code: 404,
//       message: "reservation not found"
//     };
//   }
// };

       const deleteReservation = async id => {
  if (mongoose.Types.ObjectId.isValid(id) === false) {
    return {
      code: 422,
      message: "invalid reservation id"
    };
  }
  return Reservation.findOneAndDelete({
    _id: id
  });
};

// ###############################################################################
// ### service
// ###############################################################################

       const getServiceById = async id => {
  if (mongoose.Types.ObjectId.isValid(id) === false) {
    return {
      code: 422,
      message: "invalid service id"
    };
  }
  return Service.findOne({
    _id: id
  });
};

       const getAllServices = () => {
  return Service.find({});
};

       const addService = async ({
  name,
  price,
  daysBeforeReservation = 0,
  quantity = 1,
  hotel
}) => {
  if (mongoose.Types.ObjectId.isValid(hotel) === false) {
    return {
      code: 422,
      message: "invalid hotel id"
    };
  } else if (
    !(await Hotel.findOne({
      _id: hotel
    }))
  ) {
    return {
      code: 404,
      message: "hotel not found"
    };
  }

  return new Service({
    name,
    price,
    daysBeforeReservation,
    quantity,
    hotel
  }).save();
};

       const updateService = async ({
  name,
  price,
  daysBeforeReservation = 0,
  quantity = 1,
  hotel,
  id
}) => {
  if (mongoose.Types.ObjectId.isValid(id) === false) {
    return {
      code: 422,
      message: "invalid service id"
    };
  }

  let service = await Service.findOne({
    _id: id
  });

  if (service) {
    if (hotel) {
      if (mongoose.Types.ObjectId.isValid(hotel) === false) {
        return {
          code: 422,
          message: "invalid hotel id"
        };
      } else if (
        !(await Hotel.findOne({
          _id: hotel
        }))
      ) {
        return {
          code: 404,
          message: "hotel not found"
        };
      }
    }

    service.name = name ? name : service.name;
    service.price = price ? price : service.price;
    service.daysBeforeReservation = daysBeforeReservation ?
      daysBeforeReservation :
      service.daysBeforeReservation;
    service.quantity = quantity ? quantity : service.quantity;
    service.hotel = hotel ? hotel : service.hotel;

    return service.save();
  } else {
    return {
      code: 404,
      message: "service not found"
    };
  }
};

       const deleteService = async id => {
  if (mongoose.Types.ObjectId.isValid(id) === false) {
    return {
      code: 422,
      message: "invalid service id"
    };
  }
  return Service.findOneAndDelete({
    _id: id
  });
};

// ###############################################################################
// ### price policy
// ###############################################################################

       const getPricePolicyById = async id => {
  if (mongoose.Types.ObjectId.isValid(id) === false) {
    return {
      code: 422,
      message: "invalid price policy id"
    };
  }
  return PricePolicy.findOne({
    _id: id
  });
};

       const getAllPricePolicies = () => {
  return PricePolicy.find({});
};

       const addPricePolicy = async ({
  name,
  value,
  maximumPerson = null,
  dayOfTheWeek = null,
  days = null,
  hotel
}) => {

  if (mongoose.Types.ObjectId.isValid(hotel) === false) {
    return {
      code: 422,
      message: "invalid hotel id"
    };
  } else if (
    !(await Hotel.findOne({
      _id: hotel
    }))
  ) {
    return {
      code: 404,
      message: "hotel not found"
    };
  }

  return new PricePolicy({
    name,
    value,
    maximumPerson,
    dayOfTheWeek,
    days,
    hotel
  }).save();
};

       const updatePricePolicy = async ({
  name,
  value,
  maximumPerson = null,
  dayOfTheWeek = null,
  days = null,
  hotel,
  id
}) => {
  if (mongoose.Types.ObjectId.isValid(id) === false) {
    return {
      code: 422,
      message: "invalid price policy id"
    };
  }

  let pricePolicy = await PricePolicy.findOne({
    _id: id
  });

  if (pricePolicy) {
    if (hotel) {
      if (mongoose.Types.ObjectId.isValid(hotel) === false) {
        return {
          code: 422,
          message: "invalid hotel id"
        };
      } else if (
        !(await Hotel.findOne({
          _id: hotel
        }))
      ) {
        return {
          code: 404,
          message: "hotel not found"
        };
      }
    }

    pricePolicy.name = name ? name : pricePolicy.name;
    pricePolicy.value = value ? value : pricePolicy.value;
    pricePolicy.maximumPerson = maximumPerson ?
      maximumPerson :
      pricePolicy.maximumPerson;
    pricePolicy.dayOfTheWeek = dayOfTheWeek ?
      dayOfTheWeek :
      pricePolicy.dayOfTheWeek;
    pricePolicy.days = days ? days : pricePolicy.days;
    pricePolicy.hotel = hotel ? hotel : pricePolicy.hotel;

    return pricePolicy.save();
  } else {
    return {
      code: 404,
      message: "price policy not found"
    };
  }
};

       const deletePricePolicy = async id => {
  if (mongoose.Types.ObjectId.isValid(id) === false) {
    return {
      code: 422,
      message: "invalid price policy id"
    };
  }
  return PricePolicy.findOneAndDelete({
    _id: id
  });
};